---
layout: post
title: "Using Open Liberty and MicroProfile to power RealWorld's "Conduit" Application"
categories: blog
author_picture: https://avatars3.githubusercontent.com/dshimo
author_github: https://github.com/dshimo
seo-title: Using Open Liberty and MicroProfile to power RealWorld's Conduit Application
seo-description: RealWorld is an open source project that seeks to educate developers of all experience levels about the many flavors of today's frameworks by being a demo app with swappable frontends and backends! It's a great way to dive into something new or familiar, and here's how I made their backend on Open Liberty.
blog_description: "RealWorld is an open source project that seeks to educate developers of all experience levels the many flavors of today's frameworks by being a demo app with swappable frontends and backends! It's a great way to dive into something new or familiar, and here's how I made their backend on Open Liberty."
open-graph-image: https://openliberty.io/img/twitter_card.jpg
---
= Using Open Liberty and MicroProfile to power RealWorld's "Conduit" Application
David Shi <https://github.com/dshimo>

In the sphere of web applications, a developer can easily feel overwhelmed by the large selection of choices when choosing a frontend, backend, and the technologies that support it. Maybe, you strategically choose what's most popular or trending. Maybe, you've stumbled across stats showing that a framework performs a particular function better. Or maybe, you just like its style. Picking out a framework can feel like buying new clothes, and wouldn't you like to try out your choice before rocking it?

link:https://github.com/gothinkster/realworld[RealWorld] aims to serve as your fitting room for building "real world" applications. Created as an open source project, RealWorld enables users to choose any combination of frontend and backend to see how they would work together in the same app that they call link:https://demo.realworld.io/["Conduit"]. 

For today's blog, I've taken advantage of several of our Open Liberty guides to help build the link:https://github.com/OpenLiberty/openliberty-realworld-example-app[backend server] for RealWorld using Open Liberty and MicroProfile. 

=== Starting a RESTful App

Let's begin by deploying a JAX-RS application with some endpoints so we can start playing with it. Using our link:https://openliberty.io/guides/rest-intro.html[guide to create a RESTful web service], we can prop up a simple endpoint to return simple messages or JSON formatted classes. As a simplified example, for our blogging website we can start with an endpoint to return an instantiated user.

[source,java]
----
    @GET
    @Path("/user")
    @Produces(MediaType.APPLICATION_JSON)
    public Response getUser() {
        User testUser = new User("Johnny Appleseed", "johnny@apples.com");
        return Response.ok(testUser.toJson()).build();
    }
----

Luckily for me, RealWorld had laid out their link:https://github.com/gothinkster/realworld/tree/master/api[API specs], so I only needed to work on providing the contents. You can view the implementation link:https://github.com/OpenLiberty/openliberty-realworld-example-app/tree/master/src/main/java/application/rest[here].

The only exception in that directory is `HealthEndpoint.java`. You can insert in that file statistics or checks you want MicroProfile Health to report, and we happen to have another link:https://openliberty.io/guides/microprofile-health.html[guide to creating a dedicated health endpoint]. In my simple case, it served as a basic test endpoint for me to ping if the application successfully started.

=== Protecting Your App

Now that we can reach and interact with our application, we want to secure our endpoints by restricting certain behaviors from unauthorized users. MicroProfile JWT serves this exact purpose, and it works for us immediately out-of-the-box. 

In RealWorld's application, we generate and provide a new token when creating a new user and after a successful login. Open Liberty provides a link:https://openliberty.io/guides/microprofile-jwt.html[guide to securing microservices with JWT], and I used it to write a link:https://github.com/OpenLiberty/openliberty-realworld-example-app/blob/master/src/main/java/security/JwtGenerator.java[JwtGenerator] to wrap in the link:https://github.com/OpenLiberty/openliberty-realworld-example-app/blob/master/src/main/java/application/rest/UsersAPI.java[User API].

Since most operations involving users require authentication, I defautly locked all endpoints to a certain role with `@RolesAllowed`, and then chose to allow anyone to register specifically with `@PermitAll`.

[source,java]
----
@Path("/")
@RolesAllowed("users")
public class UsersAPI {
    /* Register */
    @POST
    @Path("/users")
    @PermitAll // allow anyone to register
    @Consumes(MediaType.APPLICATION_JSON)
    @Produces(MediaType.APPLICATION_JSON)
    public Response createUser(CreateUser requestBody) {
        ...
    }

    /* Update User */
    @PUT
    @Path("/user")
    @Consumes(MediaType.APPLICATION_JSON)
    @Produces(MediaType.APPLICATION_JSON)
    public Response update(CreateUser requestBody)
        ...
    }
}
----

=== Adding Persistence

After developing your application along with new users or objects interacting with each other, we must consider persisting these objects otherwise they will vanish from memory when the server stops. And as you guess it, we have a link:https://openliberty.io/guides/jpa-intro.html[guide to persisting data with JPA] as well. 

With JPA, we can organize create, read, update, and delete (CRUD) operations into a Data Access Object (DAO), and not have to fret over other data management implementation details. As JPA is a collection of interfaces, your code would look the same across different persistence providers, which would house your data implementation.

Continuing with the pattern for using Users as an example, here's a `UserDao`, with the other DAO files located link:https://github.com/OpenLiberty/openliberty-realworld-example-app/tree/master/src/main/java/dao[here].

[source,java]
----
public class UserDao {

    @PersistenceContext(name = "realWorld-jpa")
    private EntityManager em;

    public void createUser(User user) {
        try {
            em.persist(user);
        } catch(Exception e) {
            e.printStackTrace();
        }
    }

    public User findUser(Long userId) {
        try {
            return (userId == null) ? null: em.find(User.class, userId);
        } catch (NoResultException e) {
            return null;
        }
    }

    public User updateUser(User user, User newUser) {
        if (user == null) return null;
        user.update(
            newUser.getEmail(), 
            newUser.getUsername(), 
            newUser.getPassword(), 
            newUser.getImg(), 
            newUser.getBio());
        return em.merge(user);
    }

    public void deleteUser(Long userId) {
        em.remove(em.find(User.class, userId));
    }

    public User login(String email, String password) {
        return em.createQuery("SELECT u FROM User u WHERE u.email = :email 
                               AND u.password = :password", User.class)
            .setParameter("email", email)
            .setParameter("password", password)
            .getSingleResult();
    }
}
----

=== Try it Out

We're all about open source, and you're welcome to pull the link:https://github.com/OpenLiberty/openliberty-realworld-example-app[code] and play with it as you wish. 

Make an issue or open a pull request. But most importantly, try testing out Open Liberty along with some other backends with some of the frontends on the link:https://github.com/gothinkster/realworld[RealWorld repo]!